EFI_KB=$(${DU} -k $<TARGET_FILE:BOOTX64.efi> | cut -f1)
ELF_KB=$(${DU} -k $<TARGET_FILE:kernel.elf> | cut -f1)
FAT_SIZE=$((2 + EFI_KB + ELF_KB))
IMG_SIZE=$((34 * 2 + FAT_SIZE * 2))

${RM} -f tmp.img
${FAT_MKFS} -f 1 -s 1 -a -r 16 -F12 -C tmp.img $FAT_SIZE
${MMD} -i tmp.img ::/EFI
${MMD} -i tmp.img ::/EFI/BOOT
${MCOPY} -i tmp.img boot/BOOTX64.efi ::/EFI/BOOT
${MCOPY} -i tmp.img kernel/kernel.elf ::/
${SFDISK} os.img < disk_layout.txt
${DD} bs=512 if=tmp.img of=os.img seek=34 conv=notrunc