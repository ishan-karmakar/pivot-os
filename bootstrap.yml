sources:
  - name: mlibc
    git: https://github.com/managarm/mlibc
    branch: master
    subdir: sources

  - name: linux-headers
    url: https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-6.9.tar.xz
    extract_path: linux-6.9
    format: tar.xz
    subdir: sources
  
  - name: binutils
    url: https://ftp.gnu.org/gnu/binutils/binutils-2.43.tar.xz
    extract_path: binutils-2.43
    format: tar.xz
    subdir: sources

packages:
  - name: binutils
    from_source: binutils
    configure:
      - args:
          - '@THIS_SOURCE_DIR@/configure'
          - --target=x86_64-linux
          - '--prefix=@THIS_COLLECT_DIR@'
          - '--with-sysroot=@SYSROOT_DIR@'
          - --enable-targets=x86_64-elf
    build:
      - args: [make, '-j@PARALLELISM@', all-binutils, all-gas, all-ld]
      - args: [make, '-j@PARALLELISM@', install-binutils, install-gas, install-ld]

  - name: linux-headers
    from_source: linux-headers
    build:
      - args: [make, '-C@THIS_SOURCE_DIR@', '-j@PARALLELISM@', headers_install]
      - args: [mkdir, -p, '@THIS_COLLECT_DIR@/usr']
      - args: [cp, -r, '@THIS_SOURCE_DIR@/usr/include', '@THIS_COLLECT_DIR@/usr']

  - name: mlibc
    from_source: mlibc
    pkgs_required: [linux-headers]
    configure:
      - args:
          - meson
          - setup
          - --buildtype=release
          - -Dlinux_kernel_headers=@BUILD_ROOT@/packages/linux-headers/usr/include
          - '@THIS_SOURCE_DIR@'
    build:
      - args: [ninja]
      - args: [ninja, install]
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: initrd
    source:
      subdir: sources
    pkgs_required: [binutils, linux-headers, mlibc]